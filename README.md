# Terraform Linode Cloudflare

![terraform-linode-cloudflare](https://user-images.githubusercontent.com/4478206/144746465-3da65f8f-d522-4136-b8de-b44705f09752.png)

## Description

Using Terraform, this configuration will allow you to spin up multiple Linode instances, create Cloudflare A records for the Linode instances and apply rDNS to the Linode instances.

## Prerequisites

- [Linode Account](https://linode.com)
- [Cloudflare Account](https://www.cloudflare.com/)
- Domain name
- [Terraform installed](https://learn.hashicorp.com/tutorials/terraform/install-cli)
- [List of current images](https://api.linode.com/v4/images)
- [List of current instance types](https://api.linode.com/v4/linode/types)

## Authentication

Multiple tokens will be required to authenticate terraform with Linode and Cloudflare.

- [Linode API Token](https://www.linode.com/docs/guides/getting-started-with-the-linode-api/)
- [Cloudflare API Token](https://developers.cloudflare.com/api/tokens/create)
- [Cloudflare Zone ID](https://community.cloudflare.com/t/where-to-find-zone-id/132913)
- Cloudflare Account ID (optional, useful for Terraform Cloud variable sets)
- [SSH Public Key](https://www.linode.com/docs/guides/use-public-key-authentication-with-ssh) (recommended)

## Single Linode Instance

This example `terraform.tfvars` will deploy a single Linode instance.

```terraform
server_name = [ "ubuntu20.04" ]
authorized_keys = "ecdsa-sha2-nistp256 AAAAE2...rTucc= dgibbs@home"
linode_token = "--- Linode API Token ---"
linode_image = [ "linode/ubuntu20.04" ]
linode_region = "eu-west"
linode_type = "g6-nanode-1"
linode_tags = [ "Tag 1", "Tag 2" ]
cloudflare_token = "--- Cloudflare API Token ---"
cloudflare_zone_id = "--- Cloudflare Zone ID ---"
#cloudflare_account_id = "--- Cloudflare Account ID ---"
```

## Multiple Linode Instance

This example `terraform.tfvars` will deploy multiple Linode instances.

This example will create 5 Linode instances using different distro images. It does this by using arrays and will loop through each `server_name`. It is also possible using the same arrays to specify different _regions_ and _types_ by adding `[count.index]` in `main.tf`.

```terraform
server_name = [ "ubuntu20.04", "ubuntu18.04", "debian11", "almalinux8", "centos7" ]
authorized_keys = "ecdsa-sha2-nistp256 AAAAE2...rTucc= dgibbs@home"
linode_token = "--- Linode API Token ---"
linode_image = [ "linode/ubuntu20.04", "linode/ubuntu18.04", "linode/debian11", "linode/almalinux8", "linode/centos7" ]
linode_region = "eu-west"
linode_type = "g6-nanode-1"
linode_tags = [ "Tag 1", "Tag 2" ]
cloudflare_token = "--- Cloudflare API Token ---"
cloudflare_zone_id = "--- Cloudflare Zone ID ---"
#cloudflare_account_id = "--- Cloudflare Account ID ---"
```

---

The following reference section is auto-generated by `terraform-docs`.

<!-- prettier-ignore-start -->
<!-- textlint-disable -->
<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.5.0, < 2.0.0 |
| <a name="requirement_cloudflare"></a> [cloudflare](#requirement\_cloudflare) | ~> 5.17.0 |
| <a name="requirement_linode"></a> [linode](#requirement\_linode) | ~> 3.8.0 |
| <a name="requirement_time"></a> [time](#requirement\_time) | ~> 0.13.1 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_cloudflare"></a> [cloudflare](#provider\_cloudflare) | ~> 5.17.0 |
| <a name="provider_linode"></a> [linode](#provider\_linode) | ~> 3.8.0 |
| <a name="provider_time"></a> [time](#provider\_time) | ~> 0.13.1 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [cloudflare_dns_record.cloudflare-dns](https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/dns_record) | resource |
| [linode_instance.linode-server](https://registry.terraform.io/providers/linode/linode/latest/docs/resources/instance) | resource |
| [linode_rdns.my_rdns](https://registry.terraform.io/providers/linode/linode/latest/docs/resources/rdns) | resource |
| [time_sleep.wait_300_seconds](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_authorized_keys"></a> [authorized\_keys](#input\_authorized\_keys) | SSH public keys for server access | `string` | n/a | yes |
| <a name="input_cloudflare_account_id"></a> [cloudflare\_account\_id](#input\_cloudflare\_account\_id) | Cloudflare Account ID | `string` | n/a | yes |
| <a name="input_cloudflare_token"></a> [cloudflare\_token](#input\_cloudflare\_token) | API token for Cloudflare provider | `string` | n/a | yes |
| <a name="input_cloudflare_zone_id"></a> [cloudflare\_zone\_id](#input\_cloudflare\_zone\_id) | Cloudflare Zone ID | `string` | n/a | yes |
| <a name="input_linode_image"></a> [linode\_image](#input\_linode\_image) | List of Linode image IDs | `list(string)` | n/a | yes |
| <a name="input_linode_region"></a> [linode\_region](#input\_linode\_region) | Linode region to deploy instances | `string` | n/a | yes |
| <a name="input_linode_tags"></a> [linode\_tags](#input\_linode\_tags) | Tags to assign to Linode instances | `list(string)` | `[]` | no |
| <a name="input_linode_token"></a> [linode\_token](#input\_linode\_token) | API token for Linode provider | `string` | n/a | yes |
| <a name="input_linode_type"></a> [linode\_type](#input\_linode\_type) | Linode instance type | `string` | n/a | yes |
| <a name="input_server_name"></a> [server\_name](#input\_server\_name) | List of server names for Linode instances | `list(string)` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_cloudflare_hostname"></a> [cloudflare\_hostname](#output\_cloudflare\_hostname) | Hostnames managed by Cloudflare DNS |
| <a name="output_linode_ip_addr"></a> [linode\_ip\_addr](#output\_linode\_ip\_addr) | IP addresses of the created Linode instances |
<!-- END_TF_DOCS -->
<!-- textlint-enable -->
<!-- prettier-ignore-end -->
